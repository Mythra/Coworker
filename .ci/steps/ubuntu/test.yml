---
steps:
  - script: 'docker run --name coworker-container -p 5432:5432 -e POSTGRES_PASSWORD=supasekrit -d postgres'
  - script: './.ci/wait-for-it.sh 5432'
    timeoutInMinutes: 1
  - script: 'PGPASSWORD="supasekrit" psql -h localhost -p 5432 -U postgres -c "CREATE DATABASE coworker;"'
  - script: 'PGPASSWORD="supasekrit" psql -h localhost -p 5432 -U postgres -d coworker -a -f ./src/main/resources/migrations/1_CreateDelayedWork_pg.sql'
  - script: '(cd e2e/coworker-e2e/ && THREADS=1 JDBC_URL="jdbc:postgresql://localhost:5432/coworker?user=postgres&password=supasekrit" java -jar ./target/CoworkerE2e.jar)'
    timeoutInMinutes: 2
  - script: 'docker stop $(docker ps -aq)'
  - script: 'docker rm $(docker ps -aq)'
  - script: 'docker rmi $(docker images -q)'
